{% extends "base.html" %} {% block title %}Home{% endblock %} {% block content
%}
<div class="container-fluid justify-content-center mt-4">
  <h3 class="text-center">{{ job.name }}</h3>
  <div class="row">
    <div class="col-6">
      <table class="table">
        <thead>
          <tr>
            <th colspan="2" class="text-center">Infos</th>
          </tr>
        </thead>
        <tbody>
          <form id="view_employer_form" action="view-profile" method="get">
            <input type="hidden" name="id" value="{{ job.employer.id }}" />
          </form>
          <tr
            onclick="document.getElementById('view_employer_form').submit();"
            onmouseover="this.classList.add('thead-light'); "
            onmouseleave="this.classList.remove('thead-light');"
          >
            <th>Arbeitgeber</th>
            <th>
              <div class="d-inline-flex">
                <img
                  src="{{ url_for('views.profile.profile_image', user_id=job.employer.id) }}"
                  alt="Profilbild"
                  class="hover-overlay rounded-circle"
                  style="width: 3vh; height: 3vh"
                />
                <p class="mb-0 ml-2">
                  {{ job.employer.first_name }} {{ job.employer.last_name }}
                </p>
              </div>
            </th>
          </tr>
          <tr>
            <th>Dauer</th>
            <th>{{ job.duration // 60 }}:{{ job.duration % 60}}</th>
          </tr>
          <tr>
            <th>Bezahlung</th>
            <th>{{ job.payment // 100 }},{{ job.payment % 100 }}€</th>
          </tr>
          <tr>
            <th>Start Zeit</th>
            <th>
              {{ datetime.fromtimestamp(job.time_start).strftime("%H:%M
              %d.%m.%Y") }}
            </th>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="col-6">
      <div class="h-100 w-100 border">
        <div id="msgs_box" class="d-flex-column">
          <script>
            // prettier-ignore
            let msgs_send = {{ msgs_send|tojson }};
            let msgs_receive = {{ msgs_receive|tojson }};
          </script>
          <script>
            let msgs_box = document.getElementById("msgs_box");
            function create_msg(msg, send) {
              let div_outer = document.createElement("div");
              let div_inner = document.createElement("div");
              let p = document.createElement("p");
              p.innerHTML = msg;
              div_inner.appendChild(p);
              div_outer.appendChild(div_inner);
              div_inner.classList.add("border-secondary", "border", "rounded");
              div_outer.classList.add("d-flex");
              p.classList.add("m-0", "pr-2", "pl-2");
              if (send) {
                div_inner.style = "background-color: #7186a8;";
              } else {
                div_outer.classList.add("justify-content-end");
                div_inner.style = "background-color: #3665b3;";
              }
              msgs_box.appendChild(div_outer);
            }
            while (true) {
              if (msgs_send.length == 0) {
                msgs_receive.forEach((msg) => {
                  create_msg(msg.content, false);
                });
                break;
              } else if (msgs_receive.length == 0) {
                msgs_send.forEach((msg) => {
                  create_msg(msg.content, true);
                });
                break;
              }
              if (msgs_send[0].time < msgs_receive[0].time) {
                create_msg(msgs_send.shift().content, true);
              } else {
                create_msg(msgs_receive.shift().content, false);
              }
            }
          </script>
        </div>
      </div>
      <div class="align-bottom input-group">
        <input
          id="input_msg"
          type="text"
          name="message"
          class="form-control"
          placeholder="Nachricht..."
        />
        <div class="input-group-append">
          <button
            id="send_msg_submit"
            type="submit"
            class="btn btn-primary btn-outline-secondary"
            employer_id="{{ job.employer.id }}"
          >
            ✉
          </button>
          <script>
            // send msg
            let submit = document.getElementById("send_msg_submit");
            submit.addEventListener("click", function () {
              let input = document.getElementById("input_msg");
              if (input.value.length < 0) {
                alert("Nachricht muss mindestens ein Zeichen beinhalten!");
              } else if (input.value.lenght > 2048) {
                alert("Nachricht darf maximal 2048 Zeichen groß sein!");
              } else {
                socket.emit(
                  "job_msg_send",
                  input.value,
                  submit.getAttribute("employer_id")
                );
                create_msg(input.value, true);
                input.value = "";
              }
            });
            // receive msg
            socket.on("receive_msg", function (msg) {
              create_msg(msg, false);
            });
          </script>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
